<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô TCAS (v 1.4.1 - Warning TGAT)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #09090b; --card: #18181b; --border: #27272a; --accent: #22c55e; }
        body { background: var(--bg); color: #e4e4e7; font-family: 'Prompt', sans-serif; padding: 12px; padding-bottom: 40px; }
        
        /* Glass Card */
        .glass { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(12px); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; height: 100%; display: flex; flex-direction: column; }
        .glass-header { background: rgba(39, 39, 42, 0.4); border-bottom: 1px solid var(--border); padding: 10px 14px; font-weight: 600; color: #a1a1aa; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        
        /* Inputs */
        input, select { background: #000; border: 1px solid #3f3f46; color: white; padding: 0 12px; height: 42px; border-radius: 8px; width: 100%; font-size: 16px; font-family: 'Prompt', sans-serif; transition: 0.2s; }
        input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.1); }
        input::placeholder { color: #52525b; font-size: 0.85rem; }
        
        label { display: block; font-size: 0.8rem; color: #d4d4d8; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Buttons */
        .btn-zinc { background: #27272a; color: white; border: 1px solid #3f3f46; padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; }
        .btn-main { background: var(--accent); color: black; font-weight: 600; padding: 10px 24px; border-radius: 8px; transition: 0.2s; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2); }
        .btn-main:active { transform: scale(0.98); }
        .btn-danger { background: rgba(220, 38, 38, 0.2); color: #f87171; border: 1px solid #7f1d1d; padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: 0.2s; }
        .btn-danger:hover { background: rgba(220, 38, 38, 0.4); border-color: #ef4444; color: white; }

        /* Grid System */
        .grid-inputs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 16px; }
        @media (min-width: 768px) {
            .grid-inputs { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
            body { padding: 20px; }
        }
        
        .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; border: 1px solid #3f3f46; background: #18181b; color: #a1a1aa; margin-right: 4px; margin-bottom: 4px; display: inline-block; }
        
        /* Analysis Table Style */
        details > summary { list-style: none; cursor: pointer; color: #fbbf24; font-size: 0.8rem; font-weight: 600; padding: 8px; border-radius: 6px; background: rgba(251, 191, 36, 0.1); text-align: center; margin-top: 10px; border: 1px solid rgba(251, 191, 36, 0.2); transition: 0.2s; }
        details > summary:hover { background: rgba(251, 191, 36, 0.2); }
        .analysis-table { width: 100%; font-size: 0.75rem; border-collapse: separate; border-spacing: 0; margin-top: 8px; }
        .analysis-table th { color: #a1a1aa; padding: 6px; border-bottom: 1px solid #333; font-weight: 600; text-align: center; background: #27272a; }
        .analysis-table td { padding: 6px; border-bottom: 1px solid #27272a; text-align: center; font-family: 'JetBrains Mono'; color: #d4d4d8; }
        .analysis-table tr:last-child td { border-bottom: none; }
        
        /* Load More Button */
        #loadMoreBtn { width: 100%; padding: 12px; background: #18181b; border: 1px dashed #3f3f46; color: #a1a1aa; border-radius: 8px; margin-top: 20px; cursor: pointer; transition: 0.2s; }
        #loadMoreBtn:hover { background: #27272a; color: white; border-color: white; }

        /* Footer Disclaimer */
        footer { margin-top: 40px; padding-top: 24px; border-top: 1px solid #27272a; color: #71717a; font-size: 0.75rem; line-height: 1.6; }
        footer strong { color: #a1a1aa; }
        footer a { color: #22c55e; text-decoration: none; transition: 0.2s; }
        footer a:hover { text-decoration: underline; color: #4ade80; }
    </style>
</head>
<body class="max-w-6xl mx-auto">

    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div class="w-full md:w-auto">
            <h1 class="text-2xl md:text-3xl font-bold text-white mb-2 flex items-center flex-wrap gap-2">
                ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì <span class="text-green-500">TCAS</span> 
                <span class="text-[10px] border border-zinc-700 text-zinc-500 px-2 py-0.5 rounded align-middle whitespace-nowrap">v 1.4.1 Warning</span>
            </h1>
            <div class="flex flex-wrap gap-3 items-center">
                <div id="statusBadge" class="flex items-center gap-2 text-xs text-zinc-500">
                    <div class="w-2 h-2 rounded-full bg-zinc-600 animate-pulse"></div> ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
                </div>
                <div class="flex items-center gap-2 text-xs text-zinc-400 bg-zinc-900 px-2 py-1 rounded-full border border-zinc-800">
                    <i class="fa-solid fa-eye text-green-500"></i>
                    <span>‡∏ä‡∏°: <span id="visitorCountDisplay" class="text-white font-mono font-bold">...</span></span>
                </div>
            </div>
        </div>
        <div class="w-full md:w-auto flex flex-wrap gap-2">
            <button onclick="resetData()" class="btn-danger flex-1 md:flex-none" title="‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">
                <i class="fa-solid fa-trash-can"></i> <span class="md:hidden">‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤</span>
            </button>

            <button onclick="downloadTemplate()" class="btn-zinc flex-1 md:flex-none hover:border-green-500 hover:text-green-400 transition-colors">
                <i class="fa-solid fa-file-excel"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
            </button>
            
            <button onclick="document.getElementById('fileUpload').click()" class="btn-zinc flex-1 md:flex-none hover:border-blue-500 hover:text-blue-400 transition-colors">
                <i class="fa-solid fa-cloud-arrow-up"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
            </button>
            <input type="file" id="fileUpload" hidden accept=".xlsx,.json" onchange="handleFileUpload(this)">
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-8">
        
        <div class="glass border-l-4 border-l-yellow-500">
            <div class="glass-header text-yellow-500"><i class="fa-solid fa-star"></i> GPAX & TGAT</div>
            <div class="p-4 md:p-5 flex flex-col gap-4 h-full justify-start">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="font-bold text-white">GPAX (‡πÄ‡∏Å‡∏£‡∏î)</label><input type="number" id="GPAX" placeholder="0.00-4.00" class="score-input text-lg font-mono text-yellow-400 border-yellow-500/30 bg-yellow-500/5 focus:bg-black"></div>
                    <div>
                        <label class="font-bold text-white">TGAT ‡∏£‡∏ß‡∏° <span id="tgatWarning" class="text-red-500 text-[10px] hidden font-normal animate-pulse ml-1">* ‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ô‡∏µ‡πâ</span></label>
                        <input type="number" id="TGAT" placeholder="Auto" class="score-input text-lg font-mono text-green-400 border-green-500/30 bg-green-500/5 focus:bg-black" oninput="autoCalcTGAT()">
                    </div>
                </div>
                <div class="bg-zinc-900/50 rounded-xl p-3 border border-zinc-800">
                    <div class="text-[10px] text-zinc-500 mb-2 flex items-center gap-1"><i class="fa-solid fa-calculator"></i> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (Auto Calc)</div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="text-[10px] text-zinc-500 text-center block whitespace-normal leading-tight">
                                <span class="font-bold text-zinc-300">TGAT1</span> ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£
                            </label>
                            <input type="number" id="TGAT1" class="calc-trigger score-input text-center text-sm" placeholder="‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©">
                        </div>
                        <div>
                            <label class="text-[10px] text-zinc-500 text-center block whitespace-normal leading-tight">
                                <span class="font-bold text-zinc-300">TGAT2</span> ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
                            </label>
                            <input type="number" id="TGAT2" class="calc-trigger score-input text-center text-sm" placeholder="‡∏ï‡∏£‡∏£‡∏Å‡∏∞">
                        </div>
                        <div>
                            <label class="text-[10px] text-zinc-500 text-center block whitespace-normal leading-tight">
                                <span class="font-bold text-zinc-300">TGAT3</span> ‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞
                            </label>
                            <input type="number" id="TGAT3" class="calc-trigger score-input text-center text-sm" placeholder="‡∏ó‡∏≥‡∏á‡∏≤‡∏ô">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass border-l-4 border-l-blue-500">
            <div class="glass-header text-blue-400"><i class="fa-solid fa-flask"></i> A-Level ‡∏ß‡∏¥‡∏ó‡∏¢‡πå-‡∏Ñ‡∏ì‡∏¥‡∏ï</div>
            <div class="grid-inputs">
                <div><label>‡∏Ñ‡∏ì‡∏¥‡∏ï 1 (‡πÄ‡∏û‡∏¥‡πà‡∏°)</label><input type="number" id="Math1" class="score-input"></div>
                <div><label>‡∏Ñ‡∏ì‡∏¥‡∏ï 2 (‡∏û‡∏∑‡πâ‡∏ô)</label><input type="number" id="Math2" class="score-input"></div>
                <div><label>‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå</label><input type="number" id="Phy" class="score-input"></div>
                <div><label>‡πÄ‡∏Ñ‡∏°‡∏µ</label><input type="number" id="Chem" class="score-input"></div>
                <div><label>‡∏ä‡∏µ‡∏ß‡∏∞</label><input type="number" id="Bio" class="score-input"></div>
                <div><label>‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå</label><input type="number" id="Sci" class="score-input"></div>
            </div>
        </div>

        <div class="glass border-l-4 border-l-pink-500">
            <div class="glass-header text-pink-400"><i class="fa-solid fa-shapes"></i> TPAT ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏ô‡∏±‡∏î</div>
            <div class="p-4 md:p-5 flex flex-col gap-4">
                <div class="grid grid-cols-3 gap-2">
                    <div><label>TPAT3 (‡∏ß‡∏¥‡∏®‡∏ß‡∏∞)</label><input type="number" id="TPAT3" class="score-input text-center px-1"></div>
                    <div><label>TPAT4 (‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï)</label><input type="number" id="TPAT4" class="score-input text-center px-1"></div>
                    <div><label>TPAT5 (‡∏Ñ‡∏£‡∏∏)</label><input type="number" id="TPAT5" class="score-input text-center px-1"></div>
                </div>
                <div class="border-t border-zinc-800 pt-3 mt-auto">
                    <label class="mb-2 text-xs text-pink-300">TPAT 1 (‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏û‡∏ó‡∏¢‡πå)</label>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="TPAT11" placeholder="Part 1" class="score-input text-center text-sm px-1">
                        <input type="number" id="TPAT12" placeholder="Part 2" class="score-input text-center text-sm px-1">
                        <input type="number" id="TPAT13" placeholder="Part 3" class="score-input text-center text-sm px-1">
                    </div>
                </div>
            </div>
        </div>

        <div class="glass border-l-4 border-l-orange-500">
            <div class="glass-header text-orange-400"><i class="fa-solid fa-book"></i> ‡πÑ‡∏ó‡∏¢ - ‡∏™‡∏±‡∏á‡∏Ñ‡∏° - Eng</div>
            <div class="p-4 md:p-5">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label>‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</label><input type="number" id="Thai" class="score-input"></div>
                    <div><label>‡∏™‡∏±‡∏á‡∏Ñ‡∏°</label><input type="number" id="Soc" class="score-input"></div>
                </div>
                <div class="pt-1"><label>‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</label><input type="number" id="Eng" class="score-input border-orange-500/30"></div>
            </div>
        </div>

        <div class="glass col-span-1 lg:col-span-2 border-l-4 border-l-purple-500">
            <div class="glass-header text-purple-400 justify-between">
                <div><i class="fa-solid fa-language"></i> ‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® (PAT 7)</div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 p-4 md:p-5">
                <div><label>‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏®‡∏™</label><input type="number" id="Fre" class="score-input"></div>
                <div><label>‡πÄ‡∏¢‡∏≠‡∏£‡∏°‡∏±‡∏ô</label><input type="number" id="Ger" class="score-input"></div>
                <div><label>‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô</label><input type="number" id="Jap" class="score-input"></div>
                <div><label>‡∏à‡∏µ‡∏ô</label><input type="number" id="Chi" class="score-input"></div>
                <div><label>‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ</label><input type="number" id="Kor" class="score-input"></div>
                <div><label>‡∏ö‡∏≤‡∏•‡∏µ</label><input type="number" id="Pali" class="score-input"></div>
            </div>
        </div>
    </div>

    <div class="glass p-3 md:p-4 sticky top-0 z-50 shadow-2xl shadow-black/80 border-green-500/30 mb-8 backdrop-blur-xl rounded-none md:rounded-xl -mx-3 md:mx-0 border-x-0 md:border-x">
        <div class="flex flex-col md:flex-row gap-3">
            <div class="relative flex-1">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                <input type="text" id="smartSearch" class="pl-9 h-10 md:h-12 bg-black/50 border-zinc-700 focus:border-green-500 text-base md:text-lg w-full" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏≠ ‡∏°‡∏ò, ‡∏ß‡∏¥‡∏®‡∏ß‡∏∞ ‡∏à‡∏∏‡∏¨‡∏≤, ‡πÄ‡∏†‡∏™‡∏±‡∏ä ‡∏®‡∏¥‡∏•‡∏õ‡∏≤‡∏Å‡∏£..." onkeyup="debouncedFilter()">
            </div>
            <button onclick="calculate()" class="btn-main whitespace-nowrap px-6 text-base md:text-lg h-10 md:h-12 flex items-center justify-center gap-2 w-full md:w-auto">
                <i class="fa-solid fa-calculator"></i> <span class="md:hidden">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</span><span class="hidden md:inline">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ï‡∏¥‡∏î</span>
            </button>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2">
            <select id="filterType" onchange="runFilter()" class="h-9 text-xs bg-zinc-900 border-zinc-700 rounded">
                <option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô</option>
                <option value="‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•">‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•</option>
                <option value="‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô">‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô</option>
                <option value="‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏è">‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏è</option>
                <option value="‡∏£‡∏≤‡∏ä‡∏°‡∏á‡∏Ñ‡∏•">‡∏£‡∏≤‡∏ä‡∏°‡∏á‡∏Ñ‡∏•</option>
            </select>
            <select id="filterGroup" onchange="runFilter()" class="h-9 text-xs bg-zinc-900 border-zinc-700 rounded">
                <option value="all">‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏ì‡∏∞</option>
                <option value="‡∏™‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û">‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</option>
                <option value="‡∏ß‡∏¥‡∏®‡∏ß‡∏∞/‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô/‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡πå">‡∏ß‡∏¥‡∏®‡∏ß‡∏∞/IT</option>
                <option value="‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£/‡∏®‡∏¥‡∏•‡∏õ‡πå/‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°">‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£/‡∏®‡∏¥‡∏•‡∏õ‡πå</option>
            </select>
             <select id="sortFilter" onchange="runFilter()" class="h-9 text-xs bg-zinc-900 border-zinc-700 col-span-2 md:col-span-2 rounded">
                <option value="default">‡πÄ‡∏£‡∏µ‡∏¢‡∏á: ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</option>
                <option value="chance">‡πÄ‡∏£‡∏µ‡∏¢‡∏á: ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ï‡∏¥‡∏î‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î</option>
                <option value="score_asc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á: ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î (‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å)</option>
            </select>
        </div>
    </div>
    
    <div class="flex justify-between items-end mb-2 px-1">
        <h2 class="text-zinc-500 text-sm">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</h2>
        <div id="resultCountDisplay" class="text-green-500 text-sm font-bold">...</div>
    </div>

    <div id="resultsArea" class="space-y-3 md:space-y-4"></div>
    <button id="loadMoreBtn" class="hidden" onclick="loadMore()">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°...</button>

    <footer>
        <div class="glass p-5 border border-zinc-800">
            <h3 class="font-bold text-zinc-400 mb-2">‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (Disclaimer):</h3>
            <p class="mb-2">
                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÉ‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏ô‡∏µ‡πâ ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô 
                <strong class="text-zinc-300">‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå mytcas.com ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à</strong>
            </p>
            <p class="mb-2">
                <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á TCAS69) 
                ‡πÇ‡∏î‡∏¢‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î-‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤ 2568 ‡∏ã‡∏∂‡πà‡∏á‡∏ö‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡∏Ñ‡∏±‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å 
                ‡∏™‡πà‡∏á‡∏ú‡∏•‡πÉ‡∏´‡πâ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ
            </p>
            <p class="mt-4 pt-4 border-t border-zinc-800/50">
                ‡∏´‡∏≤‡∏Å‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà: 
                <a href="mailto:ohmlock.game@gmail.com"><i class="fa-solid fa-envelope"></i> ohmlock.game@gmail.com</a>
            </p>
        </div>
    </footer>

    <script>
        // ====================================================
        // 0. CONFIG & DATA
        // ====================================================
        const SHEET_ID = '1Aaj3gYyb0MKBYYdBm3OAN6qTtSuEIX43oh6DqrI_Zyk'; 
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
        const STORAGE_KEY = 'tcas_scores_v1';

        let db = [];
        let filteredDB = []; 
        let isCalculated = false;
        let currentDisplayCount = 20; 
        let firestoreDB;
        let userInputs = {}; 

        const SUBJECT_IDS = ['GPAX', 'TGAT', 'TGAT1', 'TGAT2', 'TGAT3', 'Math1', 'Math2', 'Phy', 'Chem', 'Bio', 'Sci', 'Thai', 'Soc', 'Eng', 'TPAT3', 'TPAT4', 'TPAT5', 'TPAT11', 'TPAT12', 'TPAT13', 'Fre', 'Ger', 'Jap', 'Chi', 'Kor', 'Pali', 'Bal', 'Spa'];

        // ====================================================
        // 1. UTILS & KNOWLEDGE BASE
        // ====================================================
        const searchSynonyms = {
            '‡∏´‡∏°‡∏≠': ['‡πÅ‡∏û‡∏ó‡∏¢', 'med'], '‡∏´‡∏°‡∏≠‡∏ü‡∏±‡∏ô': ['‡∏ó‡∏±‡∏ô‡∏ï', 'dent'], '‡∏´‡∏°‡∏≠‡∏¢‡∏≤': ['‡πÄ‡∏†‡∏™‡∏±‡∏ä', 'pharm'],
            '‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•': ['‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', 'nurse'], '‡∏´‡∏°‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå': ['‡∏™‡∏±‡∏ï‡∏ß‡πÅ‡∏û‡∏ó‡∏¢‡πå', 'vet'], '‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏±‡∏ï‡∏ß‡πå': ['‡∏™‡∏±‡∏ï‡∏ß‡πÅ‡∏û‡∏ó‡∏¢‡πå', 'vet'],
            '‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î': ['‡∏®‡∏±‡∏•‡∏¢', 'surg'], '‡πÅ‡∏•‡πá‡∏ö': ['‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå', '‡∏™‡∏´‡πÄ‡∏ß‡∏ä', 'lab'], 'xray': ['‡∏£‡∏±‡∏á‡∏™‡∏µ'],
            '‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û': ['‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î', 'rehab'], '‡∏à‡∏¥‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå': ['‡πÅ‡∏û‡∏ó‡∏¢', '‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä'],
            '‡∏Ñ‡∏≠‡∏°': ['‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', 'computer', 'it', 'soft', 'data', '‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®'],
            '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°': ['software', 'computer', 'it'], '‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå': ['software', 'computer', 'it'],
            '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡πâ‡∏≤‡∏ô': ['‡πÇ‡∏¢‡∏ò‡∏≤', '‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï', 'civil'], '‡πÑ‡∏ü‡∏ü‡πâ‡∏≤': ['‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', 'electro'],
            '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå': ['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏•', '‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå', 'mech'], '‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå': ['robot', 'mechatronic'],
            'ai': ['‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå', 'data'], '‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö': ['‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï', 'design', 'create', '‡∏ô‡∏¥‡πÄ‡∏ó‡∏®'],
            '‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å': ['design', 'media', 'art', 'multimedia'],
            '‡∏õ‡∏•‡∏π‡∏Å‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ': ['‡πÄ‡∏Å‡∏©‡∏ï‡∏£', 'agri'], '‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£': ['food', 'nutrition', '‡∏Ñ‡∏´‡∏Å‡∏£‡∏£‡∏°', 'chef'],
            '‡πÄ‡∏ä‡∏ü': ['‡∏Ñ‡∏´‡∏Å‡∏£‡∏£‡∏°', 'culinary'], '‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ó‡∏¢‡πå': ['‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 'sci'], '‡∏™‡∏±‡∏ï‡∏ß‡πå': ['‡∏™‡∏±‡∏ï‡∏ß', 'animal'],
            '‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏ß‡∏¢': ['‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£', '‡πÄ‡∏®‡∏£‡∏©‡∏ê', '‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô', '‡∏•‡∏á‡∏ó‡∏∏‡∏ô'],
            '‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à': ['‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£', '‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£', 'business'], '‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç': ['‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', 'account', 'math', 'stat'],
            '‡∏´‡∏∏‡πâ‡∏ô': ['‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô', 'finance', 'econ'], '‡∏î‡∏≤‡∏£‡∏≤': ['‡∏ô‡∏¥‡πÄ‡∏ó‡∏®', '‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á', 'film'],
            '‡∏†‡∏≤‡∏©‡∏≤': ['‡∏≠‡∏±‡∏Å‡∏©‡∏£', '‡∏°‡∏ô‡∏∏‡∏©‡∏¢', '‡∏®‡∏¥‡∏•‡∏õ‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 'lang'],
            '‡∏•‡πà‡∏≤‡∏°': ['‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', '‡∏à‡∏µ‡∏ô', '‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô', '‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏®‡∏™'], '‡πÅ‡∏≠‡∏£‡πå': ['‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏ô', 'aviation', 'airline', 'hospitality'],
            '‡∏™‡∏à‡πä‡∏ß‡∏ï': ['‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏ô', 'aviation'], '‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°': ['hotel', 'tourism', 'hospitality'],
            '‡πÑ‡∏Å‡∏î‡πå': ['‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß', 'tourism'], '‡∏Ñ‡∏£‡∏π': ['‡∏Ñ‡∏£‡∏∏', '‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 'education', 'teach'],
            '‡∏™‡∏≠‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠': ['‡∏Ñ‡∏£‡∏∏', '‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå'], '‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢': ['‡∏ô‡∏¥‡∏ï‡∏¥', 'law'], '‡∏ó‡∏ô‡∏≤‡∏¢': ['‡∏ô‡∏¥‡∏ï‡∏¥', 'law'],
            '‡∏ï‡∏≥‡∏£‡∏ß‡∏à': ['‡∏£‡∏±‡∏ê‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡∏£‡∏±‡∏ê‡∏õ‡∏£‡∏∞‡∏®‡∏≤‡∏™‡∏ô‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå'], '‡∏ô‡∏≤‡∏¢‡∏Å': ['‡∏£‡∏±‡∏ê‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 'pol']
        };

        const uniAliases = {
            '‡∏°‡∏ò': '‡∏ò‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 'tu': '‡∏ò‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡∏à‡∏∏‡∏¨‡∏≤': '‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏á‡∏Å‡∏£‡∏ì‡πå', 'cu': '‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏á‡∏Å‡∏£‡∏ì‡πå',
            '‡∏°‡∏Å': '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 'ku': '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡∏°‡∏Ç': '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', 'kku': '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô',
            '‡∏°‡∏ä': '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', 'cmu': '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', '‡∏°‡∏®‡∏ß': '‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡πÇ‡∏£‡∏í', 'swu': '‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡πÇ‡∏£‡∏í',
            '‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á': '‡∏û‡∏£‡∏∞‡∏à‡∏≠‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏´‡∏≤‡∏£‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á', 'kmitl': '‡∏û‡∏£‡∏∞‡∏à‡∏≠‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏´‡∏≤‡∏£‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á',
            '‡∏ö‡∏≤‡∏á‡∏°‡∏î': '‡∏û‡∏£‡∏∞‡∏à‡∏≠‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', 'kmutt': '‡∏û‡∏£‡∏∞‡∏à‡∏≠‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ',
            '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': '‡∏û‡∏£‡∏∞‡∏à‡∏≠‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡∏≠', 'kmutnb': '‡∏û‡∏£‡∏∞‡∏à‡∏≠‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡∏≠',
            '‡∏°.‡∏≠.': '‡∏™‡∏á‡∏Ç‡∏•‡∏≤‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', 'psu': '‡∏™‡∏á‡∏Ç‡∏•‡∏≤‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏°‡∏ü‡∏•': '‡πÅ‡∏°‡πà‡∏ü‡πâ‡∏≤‡∏´‡∏•‡∏ß‡∏á', 'mfu': '‡πÅ‡∏°‡πà‡∏ü‡πâ‡∏≤‡∏´‡∏•‡∏ß‡∏á',
            '‡∏°‡∏ö‡∏π‡∏£‡∏û‡∏≤': '‡∏ö‡∏π‡∏£‡∏û‡∏≤', 'buu': '‡∏ö‡∏π‡∏£‡∏û‡∏≤',
            '‡∏°‡∏®‡∏Å': '‡∏®‡∏¥‡∏•‡∏õ‡∏≤‡∏Å‡∏£', 'su': '‡∏®‡∏¥‡∏•‡∏õ‡∏≤‡∏Å‡∏£', '‡∏®‡∏¥‡∏•‡∏õ‡∏≤‡∏Å‡∏£': '‡∏®‡∏¥‡∏•‡∏õ‡∏≤‡∏Å‡∏£' 
        };

        function getExpandedKeywords(query) {
            if (!query) return [];
            const tokens = query.toLowerCase().split(/\s+/).filter(t => t);
            return tokens.map(token => {
                if (uniAliases[token]) return [uniAliases[token]];
                if (searchSynonyms[token]) return searchSynonyms[token];
                return [token];
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ====================================================
        // 2. FIREBASE & INIT
        // ====================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBYMLsoiK9VV1yOqHFQgCPOjt96VNZecGI",
            authDomain: "tcas-calculator.firebaseapp.com",
            projectId: "tcas-calculator",
            storageBucket: "tcas-calculator.firebasestorage.app",
            messagingSenderId: "748158856876",
            appId: "1:748158856876:web:618e1c16386fb562747909",
            measurementId: "G-TBV32ELDKR"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            firestoreDB = firebase.firestore();
            const countRef = firestoreDB.collection("website_stats").doc("visitors");
            countRef.get().then((doc) => {
                if (!doc.exists) countRef.set({ count: 1 });
                else countRef.update({ count: firebase.firestore.FieldValue.increment(1) });
            });
            countRef.onSnapshot((doc) => {
                if (doc.exists) document.getElementById('visitorCountDisplay').innerText = doc.data().count.toLocaleString();
            });
        } catch (e) {
            console.error("Firebase Error:", e);
            document.getElementById('visitorCountDisplay').innerText = "Offline";
        }

        async function init() {
            try {
                loadFromLocalStorage(); // Load saved data
                refreshInputCache();
                const res = await fetch(SHEET_URL);
                const text = await res.text();
                const json = JSON.parse(text.substr(47).slice(0, -2));
                const raw = parseMasterGoogleSheet(json);
                db = enrichData(raw); 
                document.getElementById('statusBadge').innerHTML = `<span class="text-green-500">‚óè</span> <span class="hidden md:inline">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>`;
                
                setupInputListeners();
                
                runFilter(); 
            } catch(e) {
                console.error(e);
                document.getElementById('statusBadge').innerHTML = `<span class="text-red-500">‚óè Offline</span>`;
            }
        }

        // ====================================================
        // 3. STORAGE & LIMIT LOGIC
        // ====================================================
        
        function setupInputListeners() {
            // Scores
            document.querySelectorAll('.score-input').forEach(el => {
                el.addEventListener('input', (e) => {
                    enforceLimit(e.target);
                    // Updated: Trigger autoCalc on any input to check warning status
                    if(e.target.id.includes('TGAT')) autoCalcTGAT();
                    saveToLocalStorage();
                });
            });
            
            // Search Input
            const searchInput = document.getElementById('smartSearch');
            if(searchInput) {
                searchInput.addEventListener('input', () => {
                    saveToLocalStorage();
                });
            }
        }

        function enforceLimit(input) {
            let val = parseFloat(input.value);
            if (isNaN(val)) return;

            let max = input.id === 'GPAX' ? 4.00 : 100;
            
            if (val > max) {
                input.value = max;
            } else if (val < 0) {
                input.value = 0;
            }
        }

        function saveToLocalStorage() {
            const data = {};
            SUBJECT_IDS.forEach(id => {
                const el = document.getElementById(id);
                if (el && el.value) data[id] = el.value;
            });
            
            const searchVal = document.getElementById('smartSearch').value;
            if(searchVal) data['smartSearch'] = searchVal;

            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (!saved) return;
            
            try {
                const data = JSON.parse(saved);
                SUBJECT_IDS.forEach(id => {
                    if (data[id]) document.getElementById(id).value = data[id];
                });
                if(data['smartSearch']) document.getElementById('smartSearch').value = data['smartSearch'];
                
                autoCalcTGAT();
            } catch (e) {
                console.error("Load Error", e);
            }
        }

        function resetData() {
            if(!confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) return;
            
            localStorage.removeItem(STORAGE_KEY);
            SUBJECT_IDS.forEach(id => {
                const el = document.getElementById(id);
                if(el) el.value = "";
            });
            document.getElementById('smartSearch').value = "";
            document.getElementById('TGAT').placeholder = "Auto";
            document.getElementById('tgatWarning').classList.add('hidden'); // Hide warning on reset
            
            refreshInputCache();
            runFilter();
        }

        // ====================================================
        // 4. CORE LOGIC
        // ====================================================

        function refreshInputCache() {
            SUBJECT_IDS.forEach(id => {
                const el = document.getElementById(id);
                userInputs[id] = el ? (parseFloat(el.value) || 0) : 0;
                userInputs[id + '_raw'] = el ? el.value : "";
            });
            if (!userInputs['TGAT'] && (userInputs['TGAT1'] || userInputs['TGAT2'] || userInputs['TGAT3'])) {
                userInputs['TGAT'] = (userInputs['TGAT1'] + userInputs['TGAT2'] + userInputs['TGAT3']) / 3;
            }
        }

        function autoCalcTGAT() {
            const t1 = parseFloat(document.getElementById('TGAT1').value) || 0;
            const t2 = parseFloat(document.getElementById('TGAT2').value) || 0;
            const t3 = parseFloat(document.getElementById('TGAT3').value) || 0;
            const tTotal = document.getElementById('TGAT');
            const warning = document.getElementById('tgatWarning');

            const hasSub = t1 > 0 || t2 > 0 || t3 > 0;
            
            // 1. Update Placeholder
            if(hasSub && !tTotal.value) {
                tTotal.placeholder = ((t1 + t2 + t3) / 3).toFixed(2);
            } else if (!hasSub) {
                tTotal.placeholder = "Auto";
            }

            // 2. Toggle Warning (Logic: If has any sub-score AND total is empty -> Show Warning)
            if (hasSub && !tTotal.value) {
                warning.classList.remove('hidden');
            } else {
                warning.classList.add('hidden');
            }
        }

        function calculate() {
            if(db.length===0) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            isCalculated = true;
            refreshInputCache(); 
            
            if(firestoreDB) {
                let savePayload = {};
                SUBJECT_IDS.forEach(id => { if(userInputs[id] > 0) savePayload[id] = userInputs[id]; });
                if(Object.keys(savePayload).length > 0) {
                     firestoreDB.collection("student_scores").add({ ...savePayload, timestamp: firebase.firestore.FieldValue.serverTimestamp() })
                     .catch(e => console.error("Save Error", e));
                }
            }
            runFilter();
        }

        const debouncedFilter = debounce(() => {
            runFilter();
        }, 300);

        function runFilter() {
            refreshInputCache(); 
            
            const searchRaw = document.getElementById('smartSearch').value;
            const searchGroups = getExpandedKeywords(searchRaw);
            const typeFilter = document.getElementById('filterType').value;
            const groupFilter = document.getElementById('filterGroup').value;
            const sortMode = document.getElementById('sortFilter').value;
            
            filteredDB = db.map(item => {
                let myTotal = 0, used = [], pendingList = [], pendingWeight = 0;
                
                for (let [sub, weight] of Object.entries(item.weights)) {
                    const isFilled = userInputs[sub + '_raw'] !== ""; 
                    let s = isCalculated ? userInputs[sub] : 0;
                    
                    if (sub === 'TPAT1' && s === 0) { 
                         s = (userInputs['TPAT11'] + userInputs['TPAT12'] + userInputs['TPAT13']);
                         if(s > 0 && !isFilled) s = s; 
                    }

                    if(sub==='GPAX' && s<=4 && isFilled) s*=25; 
                    
                    const wScore = (s * weight) / 100;
                    myTotal += wScore;
                    
                    if(weight > 0) {
                        used.push({n: sub, w: weight, s: s, isFilled: isFilled});
                        if (!isFilled && isCalculated) {
                            pendingList.push({n: sub, w: weight});
                            pendingWeight += weight;
                        }
                    }
                }
                
                let gap = null;
                if(item.minScore > 0) {
                     gap = myTotal - item.minScore;
                } else {
                     gap = -99999; 
                }
                
                return { ...item, myTotal, used, gap, pendingList, pendingWeight };
            }).filter(item => {
                const fullName = `${item.uni} ${item.subFaculty} ${item.faculty}`;
                
                let matchSearch = true;
                if (searchGroups.length > 0) {
                    matchSearch = searchGroups.every(group => group.some(kw => fullName.toLowerCase().includes(kw)));
                }
                const matchType = typeFilter === 'all' || item.tags.type === typeFilter;
                const matchGroup = groupFilter === 'all' || item.tags.group === groupFilter;
                return matchSearch && matchType && matchGroup;
            });

            document.getElementById('resultCountDisplay').innerHTML = `‡πÄ‡∏à‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${filteredDB.length} ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£`;

            if(sortMode === 'chance' && isCalculated) {
                filteredDB.sort((a,b) => b.gap - a.gap);
            }
            else if(sortMode === 'score_asc') filteredDB.sort((a,b) => {
                if(a.minScore <= 0) return 1;
                if(b.minScore <= 0) return -1;
                return a.minScore - b.minScore;
            });

            currentDisplayCount = 20;
            renderDOM();
        }

        function loadMore() {
            currentDisplayCount += 20;
            renderDOM();
        }

        function renderDOM() {
            const container = document.getElementById('resultsArea');
            const loadBtn = document.getElementById('loadMoreBtn');
            
            if(filteredDB.length === 0) {
                container.innerHTML = `<div class="text-center text-zinc-600 py-10 opacity-50">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>`;
                loadBtn.classList.add('hidden');
                return;
            }

            const displayData = filteredDB.slice(0, currentDisplayCount);
            
            let htmlBuffer = displayData.map(item => {
                const isValidCalc = item.gap > -90000; 
                const isPass = isValidCalc && item.gap >= 0;
                
                const color = isPass ? "text-green-400" : "text-red-400";
                const borderColor = (isCalculated && isValidCalc) ? (isPass ? "border-green-500/40 bg-green-900/10" : "border-red-500/40 bg-red-900/10") : "border-zinc-800";
                
                let badgeHtml = item.used.map(u => {
                    let name = u.n.replace("Math","‡∏Ñ‡∏ì‡∏¥‡∏ï").replace("Eng","‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©").replace("GPAX","‡πÄ‡∏Å‡∏£‡∏î");
                    let statusClass = u.isFilled ? (u.s > 0 ? 'text-white border-zinc-500' : 'text-zinc-500 border-zinc-700') : 'text-yellow-600 border-yellow-900/30 border-dashed';
                    let scoreText = u.isFilled ? (u.n === 'GPAX' ? (u.s/25).toFixed(2) : u.s.toFixed(0)) : '‡∏£‡∏≠‡∏™‡∏≠‡∏ö';
                    return `<span class="badge ${statusClass}">${name} ${u.w}% (${scoreText})</span>`
                }).join("");

                let strategyHtml = "";
                if (isCalculated && isValidCalc && !isPass && item.pendingList.length > 0) {
                     const avgW = item.pendingWeight / item.pendingList.length;
                     const highW = item.pendingList.filter(s => s.w >= avgW);
                     const lowW = item.pendingList.filter(s => s.w < avgW);
                     const k_factor = (Math.abs(item.gap) * 100) / (lowW.reduce((a,b)=>a+b.w,0) + (2 * highW.reduce((a,b)=>a+b.w,0)));
                     let rows = item.pendingList.sort((a,b)=>b.w - a.w).map(sub => {
                        let scale = sub.n === 'GPAX' ? 25 : 1;
                        let carry = ((Math.abs(item.gap) * 100) / sub.w) / scale;
                        let balance = ((Math.abs(item.gap) * 100) / item.pendingWeight) / scale;
                        let strat = (sub.w >= avgW ? 2*k_factor : k_factor) / scale;
                        const fmt = (v) => v > (sub.n==='GPAX'?4:100) ? `<span class="text-red-500/50">>Max</span>` : v.toFixed(1);
                        return `<tr><td class="text-left">${sub.n} (${sub.w}%)</td><td class="text-red-400 font-bold">${fmt(carry)}</td><td class="text-blue-400">${fmt(balance)}</td><td class="text-purple-400 font-bold bg-purple-900/20 rounded">${fmt(strat)}</td></tr>`;
                    }).join("");
                    strategyHtml = `<details><summary>üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Gap: ${item.gap.toFixed(2)})</summary><table class="analysis-table"><thead><tr><th class="text-left">‡∏ß‡∏¥‡∏ä‡∏≤</th><th class="text-red-400">A.Carry</th><th class="text-blue-400">B.Balance</th><th class="text-purple-400">C.Strat</th></tr></thead><tbody>${rows}</tbody></table></details>`;
                }

                let gapBox = '';
                if(isCalculated) {
                    if(isValidCalc) {
                         gapBox = `<div class="shrink-0 text-right"><div class="text-[9px] text-zinc-500 font-black uppercase tracking-widest mb-1">GAP Analysis</div><div class="text-xl md:text-3xl font-black ${color} leading-none"><span class="text-xs font-normal mr-1 opacity-60">pts</span>${item.gap > 0 ? '+' : ''}${item.gap.toFixed(2)}</div></div>`;
                    } else {
                         gapBox = `<div class="shrink-0 text-right"><div class="text-[9px] text-zinc-600 font-black uppercase tracking-widest mb-1">DATA N/A</div><div class="text-sm md:text-base font-bold text-zinc-500 bg-zinc-800 px-2 py-1 rounded">‡∏£‡∏≠‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</div></div>`;
                    }
                }

                return `
                <div class="glass p-4 md:p-5 border ${borderColor} relative group hover:border-zinc-500 transition-all shadow-md">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-3 pb-3 border-b border-zinc-800/60">
                        <div class="flex flex-wrap items-center gap-x-3 gap-y-2 min-w-0">
                            <div class="w-8 h-8 rounded bg-white p-1 flex items-center justify-center shrink-0 ring-1 ring-zinc-700 shadow-sm">
                                ${item.logo ? `<img src="${item.logo}" class="max-w-full max-h-full object-contain">` : '<i class="fa-solid fa-university text-xs text-black"></i>'}
                            </div>
                            <div class="flex items-center gap-2 flex-wrap">
                                <span class="text-base md:text-lg text-green-400 font-black uppercase tracking-wide">${item.uni}</span>
                                <span class="text-zinc-700 font-bold">|</span>
                                <span class="text-base md:text-lg text-zinc-300 font-black">${item.subFaculty}</span>
                            </div>
                            <div class="flex items-center gap-1.5">
                                <span class="text-[10px] bg-blue-600/20 text-blue-400 px-2 py-0.5 rounded border border-blue-500/30 font-black">${item.round}</span>
                                <span class="text-[10px] bg-zinc-800 text-orange-400 px-2 py-0.5 rounded border border-zinc-700 font-bold">‡∏£‡∏±‡∏ö: ${item.capacity}</span>
                            </div>
                        </div>
                        <div class="flex gap-5 shrink-0 bg-zinc-900/50 px-3 py-1.5 rounded-lg border border-zinc-800/80 mt-1 md:mt-0">
                            <div class="flex flex-col items-center"><span class="text-[9px] text-zinc-500 font-black mb-0.5 uppercase">‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î 68</span><span class="text-base md:text-lg font-mono font-black text-zinc-100">${item.minScore > 0 ? item.minScore.toFixed(2) : '-'}</span></div>
                            <div class="w-[1px] bg-zinc-800 h-8 self-center"></div>
                            <div class="flex flex-col items-center"><span class="text-[9px] text-zinc-500 font-black mb-0.5 uppercase">‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 68</span><span class="text-base md:text-lg font-mono font-black text-zinc-400">${item.maxScore > 0 ? item.maxScore.toFixed(2) : '-'}</span></div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center gap-6 mb-3">
                        <div class="flex-1 min-w-0"><h2 class="text-lg md:text-2xl text-white font-bold leading-tight tracking-tight">${item.faculty}</h2></div>
                        ${gapBox}
                    </div>
                    <div class="flex flex-wrap gap-1.5">${badgeHtml}</div>
                    ${strategyHtml ? `<div class="mt-3 pt-3 border-t border-zinc-800/40">${strategyHtml}</div>` : ''}
                </div>`;
            }).join("");

            container.innerHTML = htmlBuffer;
            
            if(filteredDB.length > currentDisplayCount) {
                loadBtn.classList.remove('hidden');
                loadBtn.innerHTML = `‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (${filteredDB.length - currentDisplayCount})`;
            } else {
                loadBtn.classList.add('hidden');
            }
        }

        // ====================================================
        // 5. PARSING & HELPERS
        // ====================================================
        function parseMasterGoogleSheet(json) {
            return json.table.rows.map((r, i) => {
                const v = (idx) => { const c = r.c[idx]; return (!c || typeof c.v !== 'number') ? (c && parseFloat(c.v)||0) : c.v; };
                const t = (idx) => { const c = r.c[idx]; return (!c || c.v === null) ? "" : String(c.v).trim(); };
                return extractDataFromRow(i, v, t);
            }).filter(x => x.faculty && x.faculty !== "");
        }

        function parseExcelFixedColumns(rows) {
            return rows.slice(1).map((r, i) => {
                const v = (idx) => { let val = parseFloat(r[idx]); return isNaN(val) ? 0 : val; };
                const t = (idx) => (r[idx] ? String(r[idx]).trim() : "");
                return extractDataFromRow(i, v, t);
            }).filter(item => item.faculty && item.faculty !== "");
        }

        function extractDataFromRow(id, getValue, getText) {
            let weights = {};
            const addW = (k, idx) => { let val = getValue(idx); if(val > 0) weights[k] = val; };
            addW("GPAX", 5); addW("TGAT", 6); addW("TGAT1", 7); addW("TGAT2", 8); addW("TGAT3", 9);
            addW("TPAT11", 10); addW("TPAT12", 11); addW("TPAT13", 12); addW("TPAT21", 13); addW("TPAT22", 14); addW("TPAT23", 15);
            addW("TPAT3", 16); addW("TPAT4", 17); addW("TPAT5", 18);
            addW("Math1", 19); addW("Math2", 20); addW("Phy", 21); addW("Chem", 22); addW("Bio", 23); addW("Sci", 24); addW("Eng", 25); addW("Thai", 26); addW("Soc", 27);
            addW("Fre", 28); addW("Ger", 29); addW("Jap", 30); addW("Kor", 31); addW("Chi", 32); addW("Bal", 33); addW("Spa", 34);

            return { 
                id: id, uni: getText(0), faculty: getText(2), subFaculty: getText(1), round: getText(4),
                minScore: getValue(35), maxScore: getValue(36), capacity: getText(37), logo: getText(38), weights: weights 
            };
        }

        function enrichData(data) {
            return data.map(item => ({ ...item, tags: { type: getUniType(item.uni||""), group: getFacultyGroup(item.faculty||"") } }));
        }

        function getUniType(uniName) {
            const name = uniName.toLowerCase();
            if (name.match(/(‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏è|rajabhat|mcru|cmru)/)) return '‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏è';
            if (name.match(/(‡∏£‡∏≤‡∏ä‡∏°‡∏á‡∏Ñ‡∏•|rmut|‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û|‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô|‡∏à‡∏¥‡∏ï‡∏£‡∏•‡∏î‡∏≤)/)) return '‡∏£‡∏≤‡∏ä‡∏°‡∏á‡∏Ñ‡∏•';
            const privateUnis = ['‡∏£‡∏±‡∏á‡∏™‡∏¥‡∏ï', 'rsu', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û', 'bu', '‡∏´‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤', 'utcc', '‡∏®‡∏£‡∏µ‡∏õ‡∏ó‡∏∏‡∏°', 'spu', '‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï‡∏¢‡πå', 'dpu', '‡∏≠‡∏±‡∏™‡∏™‡∏±‡∏°‡∏ä‡∏±‡∏ç', 'au', 'abac', '‡∏´‡∏±‡∏ß‡πÄ‡∏â‡∏µ‡∏¢‡∏ß', 'hcu', '‡πÄ‡∏Å‡∏©‡∏°‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï', 'kbu', '‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', 'mut', '‡∏™‡∏¢‡∏≤‡∏°', '‡∏û‡∏≤‡∏¢‡∏±‡∏û', '‡∏ß‡∏á‡∏©‡πå‡∏ä‡∏ß‡∏•‡∏¥‡∏ï‡∏Å‡∏∏‡∏•', '‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà', '‡∏≠‡∏µ‡∏™‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô', '‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢‡∏≠‡∏≤‡∏Ñ‡πÄ‡∏ô‡∏¢‡πå', '‡∏ï‡∏≤‡∏õ‡∏µ', '‡πÄ‡∏ã‡∏ô‡∏ï‡πå‡∏à‡∏≠‡∏´‡πå‡∏ô', '‡∏£‡∏±‡∏ï‡∏ô‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï', '‡πÄ‡∏ß‡∏™‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô', 'north', 'stamford'];
            if (privateUnis.some(kw => name.includes(kw))) return '‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô';
            return '‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•';
        }

        function getFacultyGroup(facultyName) {
            const name = facultyName.toLowerCase();
            if (name.match(/(‡πÅ‡∏û‡∏ó‡∏¢|med|‡∏®‡∏±‡∏•‡∏¢|surg|‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•|nurs|‡∏ó‡∏±‡∏ô‡∏ï|dent|‡πÄ‡∏†‡∏™‡∏±‡∏ä|pharm|‡∏™‡∏±‡∏ï‡∏ß‡πÅ‡∏û‡∏ó‡∏¢‡πå|vet|‡∏™‡∏´‡πÄ‡∏ß‡∏ä|allied|‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û|physical|‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå|lab|‡∏£‡∏±‡∏á‡∏™‡∏µ|x-ray|‡∏ó‡∏±‡∏®‡∏ô‡∏°‡∏≤‡∏ï‡∏£|optom|‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç|pub.*health|‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å)/) && !name.includes('‡∏™‡∏±‡∏ï‡∏ß‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå')) return '‡∏™‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û';
            if (name.match(/(‡∏ß‡∏¥‡∏®‡∏ß|engin|‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå|comp|‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ|tech|‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®|info|it|ict|‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•|digit|‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå|soft|‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°|innov|‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å|elec|‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï|arch|‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö|design|‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á|urban|data|ai|robot|‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå|aerospace|‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏¢‡∏≤‡∏ô)/)) return '‡∏ß‡∏¥‡∏®‡∏ß‡∏∞/‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô/‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡πå';
            if (name.match(/(‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå|science|sci|‡πÄ‡∏Ñ‡∏°‡∏µ|chem|‡∏ä‡∏µ‡∏ß|bio|‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå|phys|‡∏Ñ‡∏ì‡∏¥‡∏ï|math|‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥|stat|‡πÄ‡∏Å‡∏©‡∏ï‡∏£|agri|‡∏õ‡∏£‡∏∞‡∏°‡∏á|fisher|‡∏ß‡∏ô‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå|forest|‡∏™‡∏±‡∏ï‡∏ß‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå|animal|‡∏≠‡∏≤‡∏´‡∏≤‡∏£|food|‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£|resource|‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°|environ|‡∏Å‡∏µ‡∏¨‡∏≤|sport|‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤|ple)/) && !name.match(/(‡∏£‡∏±‡∏ê‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå|‡∏™‡∏±‡∏á‡∏Ñ‡∏°|‡∏°‡∏ô‡∏∏‡∏©‡∏¢|‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£)/)) return '‡∏ß‡∏¥‡∏ó‡∏¢‡πå/‡πÄ‡∏Å‡∏©‡∏ï‡∏£/‡∏≠‡∏≤‡∏´‡∏≤‡∏£';
            return '‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£/‡∏®‡∏¥‡∏•‡∏õ‡πå/‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°';
        }

        function downloadTemplate() {
            window.open(`https://docs.google.com/spreadsheets/d/1i3JGiJLDq3sXzrgSGzdO4qC3xmq_TcPY8ezTHimeVGc/edit?usp=sharing`, '_blank');
        }
        
        function handleFileUpload(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            if(file.name.endsWith('.xlsx')) {
                reader.readAsArrayBuffer(file);
                reader.onload = e => {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                    const processed = parseExcelFixedColumns(rows);
                    if(processed.length === 0) return alert("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                    db = enrichData(processed);
                    document.getElementById('statusBadge').innerHTML = `<span class="text-blue-400">üìÇ ‡πÑ‡∏ü‡∏•‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</span>`;
                    runFilter();
                };
            }
        }

        init();
    </script>
</body>
</html>
