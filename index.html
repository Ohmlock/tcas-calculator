<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô TCAS (v 1.1.0 - Smart Edition)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&family=JetBrains+Mono:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { --bg: #09090b; --card: #18181b; --border: #27272a; --accent: #22c55e; }
        body { background: var(--bg); color: #e4e4e7; font-family: 'Prompt', sans-serif; padding: 12px; padding-bottom: 80px; }
        
        /* Glass Card */
        .glass { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(12px); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; height: 100%; display: flex; flex-direction: column; }
        .glass-header { background: rgba(39, 39, 42, 0.4); border-bottom: 1px solid var(--border); padding: 10px 14px; font-weight: 600; color: #a1a1aa; display: flex; align-items: center; gap: 8px; font-size: 0.9rem; }
        
        /* Inputs */
        input, select { background: #000; border: 1px solid #3f3f46; color: white; padding: 0 12px; height: 42px; border-radius: 8px; width: 100%; font-size: 16px; font-family: 'Prompt', sans-serif; transition: 0.2s; }
        input:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.1); }
        input::placeholder { color: #52525b; font-size: 0.85rem; }
        
        label { display: block; font-size: 0.8rem; color: #d4d4d8; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Buttons */
        .btn-zinc { background: #27272a; color: white; border: 1px solid #3f3f46; padding: 8px 16px; border-radius: 8px; font-size: 0.85rem; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; }
        .btn-main { background: var(--accent); color: black; font-weight: 600; padding: 10px 24px; border-radius: 8px; transition: 0.2s; box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2); }
        .btn-main:active { transform: scale(0.98); }

        /* Grid System */
        .grid-inputs { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; padding: 16px; }
        @media (min-width: 768px) {
            .grid-inputs { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
            body { padding: 20px; }
        }
        
        .badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; border: 1px solid #3f3f46; background: #18181b; color: #a1a1aa; margin-right: 4px; margin-bottom: 4px; display: inline-block; }
        
        /* Analysis Table Style (New) */
        details > summary { list-style: none; cursor: pointer; color: #fbbf24; font-size: 0.8rem; font-weight: 600; padding: 8px; border-radius: 6px; background: rgba(251, 191, 36, 0.1); text-align: center; margin-top: 10px; border: 1px solid rgba(251, 191, 36, 0.2); transition: 0.2s; }
        details > summary:hover { background: rgba(251, 191, 36, 0.2); }
        .analysis-table { width: 100%; font-size: 0.75rem; border-collapse: separate; border-spacing: 0; margin-top: 8px; }
        .analysis-table th { color: #a1a1aa; padding: 6px; border-bottom: 1px solid #333; font-weight: 600; text-align: center; background: #27272a; }
        .analysis-table td { padding: 6px; border-bottom: 1px solid #27272a; text-align: center; font-family: 'JetBrains Mono'; color: #d4d4d8; }
        .analysis-table tr:last-child td { border-bottom: none; }
    </style>
</head>
<body class="max-w-6xl mx-auto">

    <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
        <div class="w-full md:w-auto">
            <h1 class="text-2xl md:text-3xl font-bold text-white mb-2 flex items-center flex-wrap gap-2">
                ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì <span class="text-green-500">TCAS</span> 
                <span class="text-[10px] border border-zinc-700 text-zinc-500 px-2 py-0.5 rounded align-middle whitespace-nowrap">v 1.1.0 Smart</span>
            </h1>
            <div class="flex flex-wrap gap-3 items-center">
                <div id="statusBadge" class="flex items-center gap-2 text-xs text-zinc-500">
                    <div class="w-2 h-2 rounded-full bg-zinc-600 animate-pulse"></div> ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...
                </div>
                <div class="flex items-center gap-2 text-xs text-zinc-400 bg-zinc-900 px-2 py-1 rounded-full border border-zinc-800">
                    <i class="fa-solid fa-eye text-green-500"></i>
                    <span>‡∏ä‡∏°: <span id="visitorCountDisplay" class="text-white font-mono font-bold">...</span></span>
                </div>
            </div>
        </div>
        <div class="w-full md:w-auto flex flex-wrap gap-2">
            <button onclick="downloadTemplate()" class="btn-zinc flex-1 md:flex-none hover:border-green-500 hover:text-green-400 transition-colors">
                <i class="fa-solid fa-file-excel"></i> ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°
            </button>
            
            <button onclick="document.getElementById('fileUpload').click()" class="btn-zinc flex-1 md:flex-none hover:border-blue-500 hover:text-blue-400 transition-colors">
                <i class="fa-solid fa-cloud-arrow-up"></i> ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå
            </button>
            <input type="file" id="fileUpload" hidden accept=".xlsx,.json" onchange="handleFileUpload(this)">
        </div>
    </header>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 md:gap-6 mb-8">
        
        <div class="glass border-l-4 border-l-yellow-500">
            <div class="glass-header text-yellow-500"><i class="fa-solid fa-star"></i> GPAX & TGAT</div>
            <div class="p-4 md:p-5 flex flex-col gap-4 h-full justify-start">
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="font-bold text-white">GPAX (‡πÄ‡∏Å‡∏£‡∏î)</label><input type="number" id="GPAX" placeholder="0.00-4.00" class="text-lg font-mono text-yellow-400 border-yellow-500/30 bg-yellow-500/5 focus:bg-black"></div>
                    <div><label class="font-bold text-white">TGAT ‡∏£‡∏ß‡∏°</label><input type="number" id="TGAT" placeholder="Auto" class="text-lg font-mono text-green-400 border-green-500/30 bg-green-500/5 focus:bg-black"></div>
                </div>
                <div class="bg-zinc-900/50 rounded-xl p-3 border border-zinc-800">
                    <div class="text-[10px] text-zinc-500 mb-2 flex items-center gap-1"><i class="fa-solid fa-calculator"></i> ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏¢‡πà‡∏≠‡∏¢ (Auto Calc)</div>
                    <div class="grid grid-cols-3 gap-2">
                        <div>
                            <label class="text-[10px] text-zinc-500 text-center block whitespace-normal leading-tight">
                                <span class="font-bold text-zinc-300">TGAT1</span> ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£
                            </label>
                            <input type="number" id="TGAT1" class="calc-trigger text-center text-sm" placeholder="‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©">
                        </div>
                        <div>
                            <label class="text-[10px] text-zinc-500 text-center block whitespace-normal leading-tight">
                                <span class="font-bold text-zinc-300">TGAT2</span> ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•
                            </label>
                            <input type="number" id="TGAT2" class="calc-trigger text-center text-sm" placeholder="‡∏ï‡∏£‡∏£‡∏Å‡∏∞">
                        </div>
                        <div>
                            <label class="text-[10px] text-zinc-500 text-center block whitespace-normal leading-tight">
                                <span class="font-bold text-zinc-300">TGAT3</span> ‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏ô‡∏∞
                            </label>
                            <input type="number" id="TGAT3" class="calc-trigger text-center text-sm" placeholder="‡∏ó‡∏≥‡∏á‡∏≤‡∏ô">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="glass border-l-4 border-l-blue-500">
            <div class="glass-header text-blue-400"><i class="fa-solid fa-flask"></i> A-Level ‡∏ß‡∏¥‡∏ó‡∏¢‡πå-‡∏Ñ‡∏ì‡∏¥‡∏ï</div>
            <div class="grid-inputs">
                <div><label>‡∏Ñ‡∏ì‡∏¥‡∏ï 1 (‡πÄ‡∏û‡∏¥‡πà‡∏°)</label><input type="number" id="Math1"></div>
                <div><label>‡∏Ñ‡∏ì‡∏¥‡∏ï 2 (‡∏û‡∏∑‡πâ‡∏ô)</label><input type="number" id="Math2"></div>
                <div><label>‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå</label><input type="number" id="Phy"></div>
                <div><label>‡πÄ‡∏Ñ‡∏°‡∏µ</label><input type="number" id="Chem"></div>
                <div><label>‡∏ä‡∏µ‡∏ß‡∏∞</label><input type="number" id="Bio"></div>
                <div><label>‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡∏õ‡∏£‡∏∞‡∏¢‡∏∏‡∏Å‡∏ï‡πå</label><input type="number" id="Sci"></div>
            </div>
        </div>

        <div class="glass border-l-4 border-l-pink-500">
            <div class="glass-header text-pink-400"><i class="fa-solid fa-shapes"></i> TPAT ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏ô‡∏±‡∏î</div>
            <div class="p-4 md:p-5 flex flex-col gap-4">
                <div class="grid grid-cols-3 gap-2">
                    <div><label>TPAT3 (‡∏ß‡∏¥‡∏®‡∏ß‡∏∞)</label><input type="number" id="TPAT3" class="text-center px-1"></div>
                    <div><label>TPAT4 (‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï)</label><input type="number" id="TPAT4" class="text-center px-1"></div>
                    <div><label>TPAT5 (‡∏Ñ‡∏£‡∏∏)</label><input type="number" id="TPAT5" class="text-center px-1"></div>
                </div>
                <div class="border-t border-zinc-800 pt-3 mt-auto">
                    <label class="mb-2 text-xs text-pink-300">TPAT 1 (‡∏ß‡∏¥‡∏ä‡∏≤‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏û‡∏ó‡∏¢‡πå)</label>
                    <div class="grid grid-cols-3 gap-2">
                        <input type="number" id="TPAT11" placeholder="Part 1" class="text-center text-sm px-1">
                        <input type="number" id="TPAT12" placeholder="Part 2" class="text-center text-sm px-1">
                        <input type="number" id="TPAT13" placeholder="Part 3" class="text-center text-sm px-1">
                    </div>
                </div>
            </div>
        </div>

        <div class="glass border-l-4 border-l-orange-500">
            <div class="glass-header text-orange-400"><i class="fa-solid fa-book"></i> ‡πÑ‡∏ó‡∏¢ - ‡∏™‡∏±‡∏á‡∏Ñ‡∏° - Eng</div>
            <div class="p-4 md:p-5">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <div><label>‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</label><input type="number" id="Thai"></div>
                    <div><label>‡∏™‡∏±‡∏á‡∏Ñ‡∏°</label><input type="number" id="Soc"></div>
                </div>
                <div class="pt-1"><label>‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</label><input type="number" id="Eng" class="border-orange-500/30"></div>
            </div>
        </div>

        <div class="glass col-span-1 lg:col-span-2 border-l-4 border-l-purple-500">
            <div class="glass-header text-purple-400 justify-between">
                <div><i class="fa-solid fa-language"></i> ‡∏†‡∏≤‡∏©‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏® (PAT 7)</div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3 p-4 md:p-5">
                <div><label>‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏®‡∏™</label><input type="number" id="Fre"></div>
                <div><label>‡πÄ‡∏¢‡∏≠‡∏£‡∏°‡∏±‡∏ô</label><input type="number" id="Ger"></div>
                <div><label>‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô</label><input type="number" id="Jap"></div>
                <div><label>‡∏à‡∏µ‡∏ô</label><input type="number" id="Chi"></div>
                <div><label>‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ</label><input type="number" id="Kor"></div>
                <div><label>‡∏ö‡∏≤‡∏•‡∏µ</label><input type="number" id="Pali"></div>
            </div>
        </div>
    </div>

    <div class="glass p-3 md:p-4 sticky top-0 z-50 shadow-2xl shadow-black/80 border-green-500/30 mb-8 backdrop-blur-xl rounded-none md:rounded-xl -mx-3 md:mx-0 border-x-0 md:border-x">
        <div class="flex flex-col md:flex-row gap-3">
            <div class="relative flex-1">
                <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-500"></i>
                <input type="text" id="smartSearch" class="pl-9 h-10 md:h-12 bg-black/50 border-zinc-700 focus:border-green-500 text-base md:text-lg w-full" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏°‡∏≠ ‡∏°‡∏ò, ‡∏ß‡∏¥‡∏®‡∏ß‡∏∞ ‡∏à‡∏∏‡∏¨‡∏≤, ‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏ß‡∏¢..." onkeyup="filterResults()">
            </div>
            <button onclick="calculate()" class="btn-main whitespace-nowrap px-6 text-base md:text-lg h-10 md:h-12 flex items-center justify-center gap-2 w-full md:w-auto">
                <i class="fa-solid fa-calculator"></i> <span class="md:hidden">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</span><span class="hidden md:inline">‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ï‡∏¥‡∏î</span>
            </button>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mt-2">
            <select id="filterType" onchange="filterResults()" class="h-9 text-xs bg-zinc-900 border-zinc-700 rounded">
                <option value="all">‡∏ó‡∏∏‡∏Å‡∏™‡∏ñ‡∏≤‡∏ö‡∏±‡∏ô</option>
                <option value="‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•">‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•</option>
                <option value="‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô">‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô</option>
                <option value="‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏è">‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏è</option>
                <option value="‡∏£‡∏≤‡∏ä‡∏°‡∏á‡∏Ñ‡∏•">‡∏£‡∏≤‡∏ä‡∏°‡∏á‡∏Ñ‡∏•</option>
            </select>
            <select id="filterGroup" onchange="filterResults()" class="h-9 text-xs bg-zinc-900 border-zinc-700 rounded">
                <option value="all">‡∏ó‡∏∏‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏ì‡∏∞</option>
                <option value="‡∏™‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û">‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û</option>
                <option value="‡∏ß‡∏¥‡∏®‡∏ß‡∏∞/‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô/‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡πå">‡∏ß‡∏¥‡∏®‡∏ß‡∏∞/IT</option>
                <option value="‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£/‡∏®‡∏¥‡∏•‡∏õ‡πå/‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°">‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£/‡∏®‡∏¥‡∏•‡∏õ‡πå</option>
            </select>
             <select id="sortFilter" onchange="filterResults()" class="h-9 text-xs bg-zinc-900 border-zinc-700 col-span-2 md:col-span-2 rounded">
                <option value="default">‡πÄ‡∏£‡∏µ‡∏¢‡∏á: ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</option>
                <option value="chance">‡πÄ‡∏£‡∏µ‡∏¢‡∏á: ‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ï‡∏¥‡∏î‡∏°‡∏≤‡∏Å‡∏™‡∏∏‡∏î</option>
                <option value="score_asc">‡πÄ‡∏£‡∏µ‡∏¢‡∏á: ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î (‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å)</option>
            </select>
        </div>
    </div>

    <div id="resultsArea" class="space-y-3 md:space-y-4"></div>

    <script>
        // ====================================================
        // 0. SMART SEARCH KNOWLEDGE BASE (NEW!)
        // ====================================================
        const searchSynonyms = {
            '‡∏´‡∏°‡∏≠': ['‡πÅ‡∏û‡∏ó‡∏¢', 'med'], '‡∏´‡∏°‡∏≠‡∏ü‡∏±‡∏ô': ['‡∏ó‡∏±‡∏ô‡∏ï', 'dent'], '‡∏´‡∏°‡∏≠‡∏¢‡∏≤': ['‡πÄ‡∏†‡∏™‡∏±‡∏ä', 'pharm'],
            '‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•': ['‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', 'nurse'], '‡∏´‡∏°‡∏≠‡∏™‡∏±‡∏ï‡∏ß‡πå': ['‡∏™‡∏±‡∏ï‡∏ß‡πÅ‡∏û‡∏ó‡∏¢‡πå', 'vet'], '‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏™‡∏±‡∏ï‡∏ß‡πå': ['‡∏™‡∏±‡∏ï‡∏ß‡πÅ‡∏û‡∏ó‡∏¢‡πå', 'vet'],
            '‡∏ú‡πà‡∏≤‡∏ï‡∏±‡∏î': ['‡∏®‡∏±‡∏•‡∏¢', 'surg'], '‡πÅ‡∏•‡πá‡∏ö': ['‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå', '‡∏™‡∏´‡πÄ‡∏ß‡∏ä', 'lab'], 'xray': ['‡∏£‡∏±‡∏á‡∏™‡∏µ'],
            '‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û': ['‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û‡∏ö‡∏≥‡∏ö‡∏±‡∏î', 'rehab'], '‡∏à‡∏¥‡∏ï‡πÅ‡∏û‡∏ó‡∏¢‡πå': ['‡πÅ‡∏û‡∏ó‡∏¢', '‡∏à‡∏¥‡∏ï‡πÄ‡∏ß‡∏ä'],
            '‡∏Ñ‡∏≠‡∏°': ['‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå', 'computer', 'it', 'soft', 'data', '‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®'],
            '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°': ['software', 'computer', 'it'], '‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡πÄ‡∏°‡∏≠‡∏£‡πå': ['software', 'computer', 'it'],
            '‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡πâ‡∏≤‡∏ô': ['‡πÇ‡∏¢‡∏ò‡∏≤', '‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï', 'civil'], '‡πÑ‡∏ü‡∏ü‡πâ‡∏≤': ['‡πÑ‡∏ü‡∏ü‡πâ‡∏≤', 'electro'],
            '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏¢‡∏ô‡∏ï‡πå': ['‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏•', '‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå', 'mech'], '‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå': ['robot', 'mechatronic'],
            'ai': ['‡∏õ‡∏±‡∏ç‡∏ç‡∏≤‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå', 'data'], '‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö': ['‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï', 'design', 'create', '‡∏ô‡∏¥‡πÄ‡∏ó‡∏®'],
            '‡∏Å‡∏£‡∏≤‡∏ü‡∏¥‡∏Å': ['design', 'media', 'art', 'multimedia'],
            '‡∏õ‡∏•‡∏π‡∏Å‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ': ['‡πÄ‡∏Å‡∏©‡∏ï‡∏£', 'agri'], '‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£': ['food', 'nutrition', '‡∏Ñ‡∏´‡∏Å‡∏£‡∏£‡∏°', 'chef'],
            '‡πÄ‡∏ä‡∏ü': ['‡∏Ñ‡∏´‡∏Å‡∏£‡∏£‡∏°', 'culinary'], '‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡∏ó‡∏¢‡πå': ['‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 'sci'], '‡∏™‡∏±‡∏ï‡∏ß‡πå': ['‡∏™‡∏±‡∏ï‡∏ß', 'animal'],
            '‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏ß‡∏¢': ['‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£', '‡πÄ‡∏®‡∏£‡∏©‡∏ê', '‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô', '‡∏•‡∏á‡∏ó‡∏∏‡∏ô'],
            '‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à': ['‡∏ú‡∏π‡πâ‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£', '‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£', 'business'], '‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç': ['‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', 'account', 'math', 'stat'],
            '‡∏´‡∏∏‡πâ‡∏ô': ['‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô', 'finance', 'econ'], '‡∏î‡∏≤‡∏£‡∏≤': ['‡∏ô‡∏¥‡πÄ‡∏ó‡∏®', '‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á', 'film'],
            '‡∏†‡∏≤‡∏©‡∏≤': ['‡∏≠‡∏±‡∏Å‡∏©‡∏£', '‡∏°‡∏ô‡∏∏‡∏©‡∏¢', '‡∏®‡∏¥‡∏•‡∏õ‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 'lang'],
            '‡∏•‡πà‡∏≤‡∏°': ['‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©', '‡∏à‡∏µ‡∏ô', '‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô', '‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏®‡∏™'], '‡πÅ‡∏≠‡∏£‡πå': ['‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏ô', 'aviation', 'airline', 'hospitality'],
            '‡∏™‡∏à‡πä‡∏ß‡∏ï': ['‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏ô', 'aviation'], '‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°': ['hotel', 'tourism', 'hospitality'],
            '‡πÑ‡∏Å‡∏î‡πå': ['‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß', 'tourism'], '‡∏Ñ‡∏£‡∏π': ['‡∏Ñ‡∏£‡∏∏', '‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 'education', 'teach'],
            '‡∏™‡∏≠‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠': ['‡∏Ñ‡∏£‡∏∏', '‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå'], '‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢': ['‡∏ô‡∏¥‡∏ï‡∏¥', 'law'], '‡∏ó‡∏ô‡∏≤‡∏¢': ['‡∏ô‡∏¥‡∏ï‡∏¥', 'law'],
            '‡∏ï‡∏≥‡∏£‡∏ß‡∏à': ['‡∏£‡∏±‡∏ê‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡∏£‡∏±‡∏ê‡∏õ‡∏£‡∏∞‡∏®‡∏≤‡∏™‡∏ô‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå'], '‡∏ô‡∏≤‡∏¢‡∏Å': ['‡∏£‡∏±‡∏ê‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 'pol']
        };

        const uniAliases = {
            '‡∏°‡∏ò': '‡∏ò‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 'tu': '‡∏ò‡∏£‡∏£‡∏°‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡∏à‡∏∏‡∏¨‡∏≤': '‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏á‡∏Å‡∏£‡∏ì‡πå', 'cu': '‡∏à‡∏∏‡∏¨‡∏≤‡∏•‡∏á‡∏Å‡∏£‡∏ì‡πå',
            '‡∏°‡∏Å': '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', 'ku': '‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå', '‡∏°‡∏Ç': '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô', 'kku': '‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô',
            '‡∏°‡∏ä': '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', 'cmu': '‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà', '‡∏°‡∏®‡∏ß': '‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡πÇ‡∏£‡∏í', 'swu': '‡∏®‡∏£‡∏µ‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡πÇ‡∏£‡∏í',
            '‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á': '‡∏û‡∏£‡∏∞‡∏à‡∏≠‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏´‡∏≤‡∏£‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á', 'kmitl': '‡∏û‡∏£‡∏∞‡∏à‡∏≠‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡πÄ‡∏à‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏´‡∏≤‡∏£‡∏•‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏ö‡∏±‡∏á',
            '‡∏ö‡∏≤‡∏á‡∏°‡∏î': '‡∏û‡∏£‡∏∞‡∏à‡∏≠‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ', 'kmutt': '‡∏û‡∏£‡∏∞‡∏à‡∏≠‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏ò‡∏ô‡∏ö‡∏∏‡∏£‡∏µ',
            '‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡∏≠': '‡∏û‡∏£‡∏∞‡∏à‡∏≠‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡∏≠', 'kmutnb': '‡∏û‡∏£‡∏∞‡∏à‡∏≠‡∏°‡πÄ‡∏Å‡∏•‡πâ‡∏≤‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡πÄ‡∏´‡∏ô‡∏∑‡∏≠',
            '‡∏°.‡∏≠.': '‡∏™‡∏á‡∏Ç‡∏•‡∏≤‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', 'psu': '‡∏™‡∏á‡∏Ç‡∏•‡∏≤‡∏ô‡∏Ñ‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå', '‡∏°‡∏ü‡∏•': '‡πÅ‡∏°‡πà‡∏ü‡πâ‡∏≤‡∏´‡∏•‡∏ß‡∏á', 'mfu': '‡πÅ‡∏°‡πà‡∏ü‡πâ‡∏≤‡∏´‡∏•‡∏ß‡∏á',
            '‡∏°‡∏ö‡∏π‡∏£‡∏û‡∏≤': '‡∏ö‡∏π‡∏£‡∏û‡∏≤', 'buu': '‡∏ö‡∏π‡∏£‡∏û‡∏≤'
        };

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏ï‡∏Å Keyword (NEW!)
        function getExpandedKeywords(query) {
            if (!query) return [];
            const tokens = query.toLowerCase().split(/\s+/).filter(t => t);
            return tokens.map(token => {
                if (uniAliases[token]) return [uniAliases[token]];
                if (searchSynonyms[token]) return searchSynonyms[token];
                return [token];
            });
        }

        // ====================================================
        // 1. CONFIG & FIREBASE
        // ====================================================
        const SHEET_ID = '1Aaj3gYyb0MKBYYdBm3OAN6qTtSuEIX43oh6DqrI_Zyk'; 
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;

        const firebaseConfig = {
            apiKey: "AIzaSyBYMLsoiK9VV1yOqHFQgCPOjt96VNZecGI",
            authDomain: "tcas-calculator.firebaseapp.com",
            projectId: "tcas-calculator",
            storageBucket: "tcas-calculator.firebasestorage.app",
            messagingSenderId: "748158856876",
            appId: "1:748158856876:web:618e1c16386fb562747909",
            measurementId: "G-TBV32ELDKR"
        };

        let db = [];
        let isCalculated = false;
        let firestoreDB;

        try {
            firebase.initializeApp(firebaseConfig);
            firestoreDB = firebase.firestore();
            
            const countRef = firestoreDB.collection("website_stats").doc("visitors");
            countRef.get().then((doc) => {
                if (!doc.exists) countRef.set({ count: 1 });
                else countRef.update({ count: firebase.firestore.FieldValue.increment(1) });
            });
            
            countRef.onSnapshot((doc) => {
                if (doc.exists) document.getElementById('visitorCountDisplay').innerText = doc.data().count.toLocaleString();
            });

        } catch (e) {
            console.error("Firebase Error:", e);
            document.getElementById('visitorCountDisplay').innerText = "Offline";
        }

        // ====================================================
        // 2. MAIN LOGIC
        // ====================================================
        
        async function init() {
            try {
                const res = await fetch(SHEET_URL);
                const text = await res.text();
                const json = JSON.parse(text.substr(47).slice(0, -2));
                const raw = parseMasterGoogleSheet(json);
                db = enrichData(raw); 
                
                document.getElementById('statusBadge').innerHTML = `<span class="text-green-500">‚óè</span> <span class="hidden md:inline">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>`;
                filterResults();
            } catch(e) {
                console.error(e);
                document.getElementById('statusBadge').innerHTML = `<span class="text-red-500">‚óè Offline</span>`;
            }
            document.querySelectorAll('.calc-trigger').forEach(el => el.addEventListener('input', autoCalcTGAT));
        }

        function downloadTemplate() {
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=xlsx`;
            window.open(url, '_blank');
        }

        function handleFileUpload(input) {
             const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            if(file.name.endsWith('.xlsx')) {
                reader.readAsArrayBuffer(file);
                reader.onload = e => {
                    const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], {header:1});
                    const processed = parseExcelFixedColumns(rows);
                    if(processed.length === 0) return alert("‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß");
                    db = enrichData(processed);
                    document.getElementById('statusBadge').innerHTML = `<span class="text-blue-400">üìÇ ‡πÑ‡∏ü‡∏•‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</span>`;
                    filterResults();
                };
            }
        }

        // --- PARSING LOGIC ---
        function parseMasterGoogleSheet(json) {
            return json.table.rows.map((r, i) => {
                const v = (idx) => (r.c[idx]?.v || 0);
                const t = (idx) => (r.c[idx]?.v || "");
                return extractDataFromRow(i, v, t);
            }).filter(x => x.faculty && x.faculty !== "");
        }

        function parseExcelFixedColumns(rows) {
            return rows.slice(1).map((r, i) => {
                const v = (idx) => {
                    let val = parseFloat(r[idx]);
                    return isNaN(val) ? 0 : val;
                };
                const t = (idx) => (r[idx] ? String(r[idx]) : "");
                return extractDataFromRow(i, v, t);
            }).filter(item => item.faculty && item.faculty !== "");
        }

        function extractDataFromRow(id, getValue, getText) {
            let weights = {};
            const addW = (k, idx) => { 
                let val = getValue(idx);
                if(val > 0) weights[k] = val; 
            };
            
            // Fixed Column Index (Mapping)
            addW("GPAX", 3);    addW("TGAT", 4);    addW("TGAT1", 5);   addW("TGAT2", 6);
            addW("TGAT3", 7);   addW("TPAT11", 8);  addW("TPAT12", 9);  addW("TPAT13", 10); 
            addW("TPAT4", 14);  addW("TPAT5", 15);  addW("TPAT3", 16);  addW("Math1", 17); 
            addW("Math2", 18);  addW("Phy", 19);    addW("Chem", 20);   addW("Bio", 21); 
            addW("Sci", 22);    addW("Eng", 23);    addW("Thai", 24);   addW("Soc", 25);
            addW("Fre", 26);    addW("Ger", 27);    addW("Jap", 28);    addW("Chi", 30); 
            
            return { 
                id: id, 
                uni: getText(0),       
                faculty: getText(1),   
                minScore: getValue(33),
                logo: getText(36),     
                weights: weights 
            };
        }

        // --- HELPERS ---
        function enrichData(data) {
            return data.map(item => ({ 
                ...item, 
                tags: { type: getUniType(item.uni||""), group: getFacultyGroup(item.faculty||"") } 
            }));
        }

        function getUniType(uniName) {
            const name = uniName.toLowerCase();
            if (name.match(/(‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏è|rajabhat|mcru|cmru)/)) return '‡∏£‡∏≤‡∏ä‡∏†‡∏±‡∏è';
            if (name.match(/(‡∏£‡∏≤‡∏ä‡∏°‡∏á‡∏Ñ‡∏•|rmut|‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û|‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ‡∏õ‡∏ó‡∏∏‡∏°‡∏ß‡∏±‡∏ô|‡∏à‡∏¥‡∏ï‡∏£‡∏•‡∏î‡∏≤)/)) return '‡∏£‡∏≤‡∏ä‡∏°‡∏á‡∏Ñ‡∏•';
            const privateUnis = ['‡∏£‡∏±‡∏á‡∏™‡∏¥‡∏ï', 'rsu', '‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û', 'bu', '‡∏´‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤', 'utcc', '‡∏®‡∏£‡∏µ‡∏õ‡∏ó‡∏∏‡∏°', 'spu', '‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï‡∏¢‡πå', 'dpu', '‡∏≠‡∏±‡∏™‡∏™‡∏±‡∏°‡∏ä‡∏±‡∏ç', 'au', 'abac', '‡∏´‡∏±‡∏ß‡πÄ‡∏â‡∏µ‡∏¢‡∏ß', 'hcu', '‡πÄ‡∏Å‡∏©‡∏°‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï', 'kbu', '‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£', 'mut', '‡∏™‡∏¢‡∏≤‡∏°', '‡∏û‡∏≤‡∏¢‡∏±‡∏û', '‡∏ß‡∏á‡∏©‡πå‡∏ä‡∏ß‡∏•‡∏¥‡∏ï‡∏Å‡∏∏‡∏•', '‡∏´‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà', '‡∏≠‡∏µ‡∏™‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô', '‡πÄ‡∏≠‡πÄ‡∏ä‡∏µ‡∏¢‡∏≠‡∏≤‡∏Ñ‡πÄ‡∏ô‡∏¢‡πå', '‡∏ï‡∏≤‡∏õ‡∏µ', '‡πÄ‡∏ã‡∏ô‡∏ï‡πå‡∏à‡∏≠‡∏´‡πå‡∏ô', '‡∏£‡∏±‡∏ï‡∏ô‡∏ö‡∏±‡∏ì‡∏ë‡∏¥‡∏ï', '‡πÄ‡∏ß‡∏™‡πÄ‡∏ó‡∏¥‡∏£‡πå‡∏ô', 'north', 'stamford'];
            if (privateUnis.some(kw => name.includes(kw))) return '‡πÄ‡∏≠‡∏Å‡∏ä‡∏ô';
            return '‡∏£‡∏±‡∏ê‡∏ö‡∏≤‡∏•';
        }

        function getFacultyGroup(facultyName) {
            const name = facultyName.toLowerCase();
            if (name.match(/(‡πÅ‡∏û‡∏ó‡∏¢|med|‡∏®‡∏±‡∏•‡∏¢|surg|‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•|nurs|‡∏ó‡∏±‡∏ô‡∏ï|dent|‡πÄ‡∏†‡∏™‡∏±‡∏ä|pharm|‡∏™‡∏±‡∏ï‡∏ß‡πÅ‡∏û‡∏ó‡∏¢‡πå|vet|‡∏™‡∏´‡πÄ‡∏ß‡∏ä|allied|‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û|physical|‡πÄ‡∏ó‡∏Ñ‡∏ô‡∏¥‡∏Ñ‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå|lab|‡∏£‡∏±‡∏á‡∏™‡∏µ|x-ray|‡∏ó‡∏±‡∏®‡∏ô‡∏°‡∏≤‡∏ï‡∏£|optom|‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç|pub.*health|‡∏à‡∏¥‡∏ï‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å)/) && !name.includes('‡∏™‡∏±‡∏ï‡∏ß‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå')) return '‡∏™‡∏≤‡∏¢‡πÅ‡∏û‡∏ó‡∏¢‡πå/‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û';
            if (name.match(/(‡∏ß‡∏¥‡∏®‡∏ß|engin|‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå|comp|‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ|tech|‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®|info|it|ict|‡∏î‡∏¥‡∏à‡∏¥‡∏ó‡∏±‡∏•|digit|‡∏ã‡∏≠‡∏ü‡∏ï‡πå‡πÅ‡∏ß‡∏£‡πå|soft|‡∏ô‡∏ß‡∏±‡∏ï‡∏Å‡∏£‡∏£‡∏°|innov|‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å|elec|‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï|arch|‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö|design|‡∏ú‡∏±‡∏á‡πÄ‡∏°‡∏∑‡∏≠‡∏á|urban|data|ai|robot|‡∏´‡∏∏‡πà‡∏ô‡∏¢‡∏ô‡∏ï‡πå|aerospace|‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏¢‡∏≤‡∏ô)/)) return '‡∏ß‡∏¥‡∏®‡∏ß‡∏∞/‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô/‡∏™‡∏ñ‡∏≤‡∏õ‡∏±‡∏ï‡∏¢‡πå';
            if (name.match(/(‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå|science|sci|‡πÄ‡∏Ñ‡∏°‡∏µ|chem|‡∏ä‡∏µ‡∏ß|bio|‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå|phys|‡∏Ñ‡∏ì‡∏¥‡∏ï|math|‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥|stat|‡πÄ‡∏Å‡∏©‡∏ï‡∏£|agri|‡∏õ‡∏£‡∏∞‡∏°‡∏á|fisher|‡∏ß‡∏ô‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå|forest|‡∏™‡∏±‡∏ï‡∏ß‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå|animal|‡∏≠‡∏≤‡∏´‡∏≤‡∏£|food|‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£|resource|‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°|environ|‡∏Å‡∏µ‡∏¨‡∏≤|sport|‡∏û‡∏•‡∏®‡∏∂‡∏Å‡∏©‡∏≤|ple)/) && !name.match(/(‡∏£‡∏±‡∏ê‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå|‡∏™‡∏±‡∏á‡∏Ñ‡∏°|‡∏°‡∏ô‡∏∏‡∏©‡∏¢|‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£)/)) return '‡∏ß‡∏¥‡∏ó‡∏¢‡πå/‡πÄ‡∏Å‡∏©‡∏ï‡∏£/‡∏≠‡∏≤‡∏´‡∏≤‡∏£';
            return '‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£/‡∏®‡∏¥‡∏•‡∏õ‡πå/‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°';
        }

        function autoCalcTGAT() {
            const v = [1,2,3].map(i => parseFloat(document.getElementById(`TGAT${i}`).value)||0);
            if(v.some(x=>x>0) && !document.getElementById('TGAT').value) 
                document.getElementById('TGAT').placeholder = `${((v[0]+v[1]+v[2])/3).toFixed(2)}`;
        }

        function getScore(name) {
            let val = parseFloat(document.getElementById(name)?.value);
            if (name === 'TGAT' && isNaN(val)) {
                const v = [1,2,3].map(i => parseFloat(document.getElementById(`TGAT${i}`).value)||0);
                if(v.some(x=>x>0)) return (v[0]+v[1]+v[2])/3;
            }
            if (name.startsWith('TPAT1')) return parseFloat(document.getElementById(name)?.value) || 0;
            return val || 0;
        }

        function calculate() {
            if(db.length===0) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
            isCalculated = true;
            
            const inputIds = ['GPAX', 'TGAT', 'TGAT1', 'TGAT2', 'TGAT3', 'Math1', 'Math2', 'Phy', 'Chem', 'Bio', 'Sci', 'Thai', 'Soc', 'Eng', 'TPAT3', 'TPAT4', 'TPAT5', 'TPAT11', 'TPAT12', 'TPAT13', 'Fre', 'Ger', 'Jap', 'Chi', 'Kor', 'Pali'];
            let studentScores = {};
            inputIds.forEach(id => { const val = parseFloat(document.getElementById(id).value); if(!isNaN(val)) studentScores[id] = val; });
            
            if(firestoreDB && Object.keys(studentScores).length > 0) {
                 firestoreDB.collection("student_scores").add({ ...studentScores, timestamp: firebase.firestore.FieldValue.serverTimestamp() })
                 .catch(e => console.error("Save Error", e));
            }
            
            filterResults();
        }

        // ====================================================
        // 3. FILTER RESULTS (UPDATED WITH STRATEGY!)
        // ====================================================

        function filterResults() {
            const searchRaw = document.getElementById('smartSearch').value;
            const searchGroups = getExpandedKeywords(searchRaw); // ‡πÉ‡∏ä‡πâ Smart Search
            const typeFilter = document.getElementById('filterType').value;
            const groupFilter = document.getElementById('filterGroup').value;
            const sortMode = document.getElementById('sortFilter').value;
            const container = document.getElementById('resultsArea');
            
            container.innerHTML = "";

            let results = db.map(item => {
                let myTotal = 0, used = [], pendingList = [], pendingWeight = 0;
                
                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô
                for (let [sub, weight] of Object.entries(item.weights)) {
                    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏∂‡∏¢‡∏±‡∏á (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö Strategy)
                    const inputEl = document.getElementById(sub);
                    const isFilled = inputEl && inputEl.value !== "";

                    let s = isCalculated ? getScore(sub) : 0;
                    if(sub==='GPAX' && s<=4 && isFilled) s*=25;
                    
                    const wScore = (s * weight) / 100;
                    myTotal += wScore;
                    
                    // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ß‡∏¥‡∏ä‡∏≤
                    if(weight > 0) {
                        used.push({n: sub, w: weight, s: s, isFilled: isFilled});
                        if (!isFilled && isCalculated) {
                            pendingList.push({n: sub, w: weight});
                            pendingWeight += weight;
                        }
                    }
                }
                
                return { 
                    ...item, 
                    myTotal, 
                    used, 
                    gap: myTotal - item.minScore,
                    pendingList,
                    pendingWeight
                };
            })
            .filter(item => {
                // Smart Search Logic
                const fullName = `${item.uni} ${item.faculty}`;
                let matchSearch = true;
                if (searchGroups.length > 0) {
                    matchSearch = searchGroups.every(group => {
                        return group.some(keyword => fullName.toLowerCase().includes(keyword));
                    });
                }
                
                const matchType = typeFilter === 'all' || item.tags.type === typeFilter;
                const matchGroup = groupFilter === 'all' || item.tags.group === groupFilter;
                return matchSearch && matchType && matchGroup;
            });

            if(sortMode === 'chance' && isCalculated) results.sort((a,b) => b.gap - a.gap);
            else if(sortMode === 'score_asc') results.sort((a,b) => a.minScore - b.minScore);

            if(results.length === 0) return container.innerHTML = `<div class="text-center text-zinc-600 py-10 opacity-50">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ñ‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>`;

            results.slice(0, 50).forEach(item => {
                const isPass = item.gap >= 0;
                const color = isPass ? "text-green-400" : "text-red-400";
                const borderColor = isCalculated ? (isPass ? "border-green-500/40 bg-green-900/10" : "border-red-500/40 bg-red-900/10") : "border-zinc-800";
                
                // Badges
                let badgeHtml = item.used.map(u => {
                    let name = u.n.replace("Math","‡∏Ñ‡∏ì‡∏¥‡∏ï").replace("Eng","‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©").replace("GPAX","‡πÄ‡∏Å‡∏£‡∏î");
                    let statusClass = u.isFilled ? (u.s > 0 ? 'text-white border-zinc-500' : 'text-zinc-500 border-zinc-700') : 'text-yellow-600 border-yellow-900/30 border-dashed';
                    let scoreText = u.isFilled ? (u.n === 'GPAX' ? (u.s/25).toFixed(2) : u.s.toFixed(0)) : '‡∏£‡∏≠‡∏™‡∏≠‡∏ö';
                    return `<span class="badge ${statusClass}">${name} ${u.w}% (${scoreText})</span>`
                }).join("");

                // Strategy Table (Calculate Only if Failed & Has Pending Subjects)
                let strategyHtml = "";
                if (isCalculated && !isPass && item.pendingList.length > 0) {
                    const avgW = item.pendingWeight / item.pendingList.length;
                    const highW = item.pendingList.filter(s => s.w >= avgW);
                    const lowW = item.pendingList.filter(s => s.w < avgW);
                    const k_factor = (Math.abs(item.gap) * 100) / (lowW.reduce((a,b)=>a+b.w,0) + (2 * highW.reduce((a,b)=>a+b.w,0)));
                    
                    let rows = item.pendingList.sort((a,b)=>b.w - a.w).map(sub => {
                        let scale = sub.n === 'GPAX' ? 25 : 1;
                        let carry = ((Math.abs(item.gap) * 100) / sub.w) / scale;
                        let balance = ((Math.abs(item.gap) * 100) / item.pendingWeight) / scale;
                        let strat = (sub.w >= avgW ? 2*k_factor : k_factor) / scale;
                        
                        const fmt = (v) => {
                            if(v > (sub.n==='GPAX'?4:100)) return `<span class="text-red-500/50">>Max</span>`;
                            return v.toFixed(1);
                        };

                        return `<tr>
                            <td class="text-left">${sub.n} (${sub.w}%)</td>
                            <td class="text-red-400 font-bold">${fmt(carry)}</td>
                            <td class="text-blue-400">${fmt(balance)}</td>
                            <td class="text-purple-400 font-bold bg-purple-900/20 rounded">${fmt(strat)}</td>
                        </tr>`;
                    }).join("");

                    strategyHtml = `
                    <details>
                        <summary>üéØ ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (Gap: ${item.gap.toFixed(2)})</summary>
                        <table class="analysis-table">
                            <thead>
                                <tr>
                                    <th class="text-left">‡∏ß‡∏¥‡∏ä‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th>
                                    <th class="text-red-400" title="‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏≥‡∏ß‡∏¥‡∏ä‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà‡∏ñ‡πâ‡∏≤‡∏ó‡∏¥‡πâ‡∏á‡∏ß‡∏¥‡∏ä‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏´‡∏°‡∏î">A.Carry</th>
                                    <th class="text-blue-400" title="‡∏´‡∏≤‡∏£‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡∏ó‡∏∏‡∏Å‡∏ß‡∏¥‡∏ä‡∏≤">B.Balance</th>
                                    <th class="text-purple-400" title="‡πÄ‡∏ô‡πâ‡∏ô‡∏ß‡∏¥‡∏ä‡∏≤ % ‡πÄ‡∏¢‡∏≠‡∏∞">C.Strat</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </details>`;
                }

                let html = `
                <div class="glass p-4 md:p-5 border ${borderColor} relative group hover:border-zinc-500 transition-all flex flex-col md:flex-row gap-3 md:gap-4 items-start">
                    <div class="flex items-center gap-3 w-full md:w-auto">
                        <div class="w-12 h-12 md:w-14 md:h-14 rounded-lg bg-white p-2 flex items-center justify-center shrink-0 shadow-lg">
                            ${item.logo ? `<img src="${item.logo}" class="max-w-full max-h-full object-contain">` : '<i class="fa-solid fa-university text-2xl text-black"></i>'}
                        </div>
                        <div class="md:hidden flex-1 min-w-0">
                            <div class="text-xs text-green-400 font-bold truncate">${item.uni}</div>
                            <div class="text-sm text-white font-bold leading-tight truncate">${item.faculty}</div>
                        </div>
                    </div>
                    
                    <div class="flex-1 min-w-0 w-full">
                        <div class="hidden md:block">
                            <div class="flex flex-wrap gap-2 mb-1">
                                <span class="text-[10px] bg-zinc-800 text-zinc-400 px-2 py-0.5 rounded-full border border-zinc-700">${item.tags.type}</span>
                            </div>
                            <div class="text-sm text-green-400 font-bold truncate">${item.uni}</div>
                            <div class="text-lg text-white font-bold leading-tight mb-2">${item.faculty}</div>
                        </div>
                        <div class="flex flex-wrap gap-y-1">${badgeHtml}</div>
                        ${strategyHtml}
                    </div>

                    <div class="flex flex-row md:flex-col justify-between w-full md:w-auto md:text-right border-t md:border-t-0 border-zinc-800 pt-3 md:pt-0 mt-1 md:mt-0 gap-4">
                        <div>
                            <div class="text-[10px] text-zinc-500">‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î 67</div>
                            <div class="text-lg md:text-xl font-mono font-bold text-zinc-300">${item.minScore>0 ? item.minScore.toFixed(2) : '-'}</div>
                        </div>
                        ${isCalculated ? `
                        <div class="md:mt-auto text-right">
                            <div class="text-[10px] text-zinc-500">‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏ï‡∏¥‡∏î</div>
                            <div class="text-xl md:text-2xl font-bold ${color}">${item.gap>0?'+':''}${item.gap.toFixed(2)}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }
        
        init();
    </script>
</body>
</html>
